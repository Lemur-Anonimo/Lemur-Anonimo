<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/tarea.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <title>Asignacion</title>
</head>

<body>
    <header class="header">
        <div class="izquierda">
            <a href="principal.html"><img src="img/menu.svg" alt="menu" class="header-img"></a>
            <a href="principal.html">
                <h2>Lemur Anonimo</h2>
            </a>
        </div>

        <nav class="centro">
            <a href="#"><img src="img/assignment.svg" alt="Tarea" class="header-img"></a>
            <a href="#">
                <h2>Tarea</h2>
            </a>

            <a href="https://calendar.google.com" target="_blank"><img src="img/calander.svg" alt="Calendario"
                    class="header-img"></a>
            <a href="https://calendar.google.com" target="_blank">
                <h2>Calendario</h2>
            </a>

            <a href="https://meet.google.com/landing" target="_blank"><img src="img/videocall.svg" alt="Video Llamada"
                    class="header-img"></a>
            <a href="https://meet.google.com/landing" target="_blank">
                <h2>Video Llamadas</h2>
            </a>
        </nav>

        <div class="derecha">
            <a href="#"><img src="img/notification.svg" alt="notif" class="header-img"></a>

            <select id="opciones" name="opciones">
                <option value="opcion1">Opción 1</option>
                <option value="opcion2">Opción 2</option>
                <option value="opcion3">Opción 3</option>
            </select>

            <a href="#"><img src="img/user.jpg" alt="user" class="user-img"></a>
        </div>
    </header>

<div class="container">
    <div class="asignacionTask">
        <div id="contenido">
            <h1>Titulo de Tarea</h1>
            <p>Lorem ipsum dolor sit amet consectetur adipisicing elit...</p>
        </div>

        <!-- Comentarios dentro de asignacionTask -->
        <div class="comentarios">
            <h1>Comentarios Privados</h1>
            <ul id="lista-comentarios"></ul>
        </div>
    </div>

<div class="subirTarea">
  <h2>Subir entrega</h2>
  <form id="form-entrega">
    <textarea id="texto_respuesta" name="texto_respuesta" placeholder="Escribe tu respuesta aquí..."></textarea>
    <!-- El input de archivo queda, pero solo usamos el nombre -->
    <input type="file" id="archivo" name="archivo" />
    <div class="btn">
      <button type="submit" id="subir">+ Añadir</button>
      <button type="button" id="hecho">Marcar como completado</button>
    </div>
  </form>
</div>
</div>

<!-- Script al final del body -->
<script>
    const idUsuario = 1; // Simulación del usuario logueado
    const idTarea = 1;   // Simulación del id de la tarea

    async function cargarComentarios(idUsuario, idTarea) {
        try {
            const response = await fetch(`http://localhost:3000/api/comentarios/${idUsuario}/${idTarea}`);
            const comentarios = await response.json();

            const lista = document.getElementById("lista-comentarios");
            lista.innerHTML = "";

            comentarios.forEach(c => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <p class="contenido">${c.contenido}</p>
                    <div class="meta">
                        <span class="usuario">Autor: ${c.autor || 'Anónimo'}</span>
                        <span class="fecha">${c.fecha_subida ? new Date(c.fecha_subida).toLocaleString() : 'Sin fecha'}</span>
                    </div>
                `;
                lista.appendChild(li);
            });
        } catch (error) {
            console.error("Error cargando comentarios:", error);
        }
    }

    // Llamamos la función al cargar la página
    cargarComentarios(idUsuario, idTarea);
</script>

<script>
  document.getElementById("form-entrega").addEventListener("submit", async (e) => {
    e.preventDefault();

    const texto_respuesta = document.getElementById("texto_respuesta").value.trim();
    const archivoInput = document.getElementById("archivo");
    const archivo = archivoInput.files[0]; // opcional
    const nombre_archivo = archivo ? archivo.name : null;

    // Simulación: valores fijos de tarea y usuario (puedes reemplazar con dinámicos)
    const id_tarea = 1;
    const id_usuario = 1;

    const body = {
      id_tarea,
      id_usuario,
      texto_respuesta,
      nombre_archivo
    };

    try {
      const response = await fetch("/api/entregas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();
      console.log("Respuesta del servidor:", data);

      alert(data.message || "Entrega enviada");
    } catch (error) {
      console.error("Error al enviar entrega:", error);
      alert("Error al enviar entrega");
    }
  });

  document.getElementById("hecho").addEventListener("click", () => {
    alert("Tarea marcada como completada");
  });
</script>


</body>

</html>